<tool id="maaslin3" name="MaAsLin3" version="0.1.0" python_template_version="3.5">
    <requirements>
    </requirements>
 


    <command detect_errors="exit_code"><![CDATA[
 


        
        rm -rf /tmp/tmp.maaslin3_output &&
        rm -f  /tmp/tmp.maaslin3_taxonomy.tsv &&
        rm -f /tmp/tmp.maaslin3_metadata.tsv &&
        mkdir /tmp/tmp.maaslin3_output &&
        rm -f /tmp/tmp.maaslin3_Results.zip &&
        cp $taxonomy /tmp/tmp.maaslin3_taxonomy.tsv &&
        cp $metadata /tmp/tmp.maaslin3_metadata.tsv &&
        Rscript '/export/galaxy-central/tools/maaslin3/R/maaslin3.R'
        /tmp/tmp.maaslin3_taxonomy.tsv
        /tmp/tmp.maaslin3_metadata.tsv
        /tmp/tmp.maaslin3_output
        --formula=$formula1
        --reference=$reference1

        #if $str($gchoice_additional_analysis_types.global_additional_analysis_types)  == "1":
			#if $str($gchoice_additional_analysis_types.random_effects)  != "None":
                --random_effects $gchoice_additional_analysis_types.random_effects
			#end if	

			#if $str($gchoice_additional_analysis_types.group_effects)  != "None":
                --group_effects $gchoice_additional_analysis_types.group_effects
			#end if	

			#if $str($gchoice_additional_analysis_types.ordered_effects)  != "None":
                --ordered_effects $gchoice_additional_analysis_types.ordered_effects
			#end if	

			#if $str($gchoice_additional_analysis_types.strata_effects)  != "None":
                --strata_effects $gchoice_additional_analysis_types.strata_effects 
			#end if	
 
		#end if



        &&
        cp /tmp/tmp.maaslin3_output/all_results.tsv  $output1 &&
        cp /tmp/tmp.maaslin3_output/significant_results.tsv  $output2 &&
        cp /tmp/tmp.maaslin3_output/figures/summary_plot.pdf $output3 &&
        zip -r  /tmp/tmp.maaslin3_Results.zip  /tmp/tmp.maaslin3_output &&
        cp /tmp/tmp.maaslin3_Results.zip $output4 &&
        rm -rf /tmp/tmp.maaslin3_output &&
        rm -f  /tmp/tmp.maaslin3_taxonomy.tsv &&
        rm -f /tmp/tmp.maaslin3_metadata.tsv &&
        rm -f /tmp/tmp.maaslin3_Results.zip
            ]]></command>
    <inputs>
        <param type="data" name="taxonomy"  label="Input Taxonomy:  Use DataType 'maaslin3_taxonomy_input' when you upload this file" format="maaslin3_taxonomy_input"  />
        <param type="data" name="metadata"  label="Input Metadata : Use DataType 'maaslin3_metadata_input' when you upload" format="maaslin3_metadata_input"  />


        <conditional name="gchoice_additional_analysis_types">
        	<param name="global_additional_analysis_types" type="select" label="Advanced parameters"  multiple="False" help="Select advanced choices ">
        		<option value="0" selected='True'>No</option>
				<option value="1">Yes</option>
        	</param>
           	<when value="0">
 				 
			</when>

        	<when value="1">
				 
				<param name="random_effects" label="random_effects: The random effects for the model, comma-delimited for multiple effects [ Default: none ]"  value="None" type="text" format="text"/>
				<param name="group_effects" label="group_effects: The group effects for the model, comma-delimited for multiple effects[ Default: none ] "  value="None" type="text" format="text"/>
				<param name="ordered_effects" label="The ordered effects for the model, comma-delimited for multiple effects [ Default: none ] "  value="None" type="text" format="text"/>
                <param name="strata_effects" label="The strata effects for the model. Only one is allowed. [ Default: none ] "  value="None" type="text" format="text"/>

			</when>
    	</conditional>
 
        <param name="formula1" type="text" label="formula: For sample use:  '~ diagnosis + dysbiosis_state + antibiotics + age + reads'" value="'~ diagnosis + dysbiosis_state + antibiotics + age + reads'">
            <sanitizer  >
                <valid initial="string.printable">
                </valid>
            </sanitizer>
        </param>


        <param name="reference1" type="text" label="formula: For sample use:  'diagnosis,nonIBD;dysbiosis_state,none;antibiotics,No'" value="'diagnosis,nonIBD;dysbiosis_state,none;antibiotics,No'">
            <sanitizer >
                <valid initial="string.printable">
                </valid>
            </sanitizer>
        </param>


    </inputs>
    <outputs>
        <data name="output1"  format="tsv" label="all results" />
        <data name="output2"  format="tsv" label="significant results" />
        <data name="output3"  format="pdf" label="Summary Plot" />
        <data name="output4"  format="zip" label="MaAsLin Output zip results - please download" />
    </outputs>
    <help><![CDATA[

MaAsLin 3 is the next generation of MaAsLin (Microbiome Multivariable Associations with Linear Models).

* This comprehensive R package efficiently determines multivariable associations between clinical metadata and microbial meta-omics features.

* Relative to MaAsLin 2,  MaAsLin 3 introduces the ability to quantify and test for both abundance and prevalence associations while accounting for compositionality.

* By incorporating generalized linear models, MaAsLin 3 accomodates most modern epidemiological study designs including cross-sectional and longitudinal studies.



**Inputs**
==========


MaAslin requires two inputs which are described here:  Inputs_Description_ 


* Taxonomy file: Possible features include taxonomy or genes. These can be relative abundances or counts.

    Sample for this file can be found in  MaAslin3_Sample_Taxonomy_ .
    
    Please upload with datatype of "maaslin3_taxonomy_input"

* Metadata file: Formatted with variables as columns and samples as rows. Possible metadata include gender or age

    Sample for this file can be found in  MaAslin3_Sample_Metadata_ .
     
    Please upload with datatype of "maaslin3_metadata_input"

 

.. image:: https://raw.githubusercontent.com/biobakery/galaxy_maaslin3/refs/heads/main/figures/summary_plot.png?token=GHSAT0AAAAAAC4FU6QOELZQ3AFBWO7KLHUYZ3QRWWA
    :height: 470        
    :width: 800 

**Outputs**
===========

* MaAsLin files explained in detail in MaAsLin3_Outputs_Description_ 
 

 ..  _MaAsLin3_Outputs_Description:  http://github.com/biobakery/maaslin3?tab=readme-ov-file#output-files
 ..  _the_manuscript: http://doi.org/10.1101/2024.12.13.628459
 ..  _MaAsLin3_Tutorial: http://github.com/biobakery/maaslin3
 ..  _MaAslin3_Sample_Taxonomy:  http://github.com/biobakery/galaxy_maaslin3/blob/main/sample_data/HMP2_taxonomy.tsv
 ..  _MaAslin3_Sample_Metadata:  http://github.com/biobakery/galaxy_maaslin3/blob/main/sample_data/HMP2_metadata.tsv
 ..  _Inputs_Description: http://github.com/biobakery/maaslin3?tab=readme-ov-file#input-data
 
 



**User Manual**
===================================


You can find the following resources:

-  MaAsLin3_Tutorial_
 


If you use the MaAsLin 3 software, please cite the_manuscript_ :

William A. Nickols, Thomas Kuntz, Jiaxian Shen, Sagun Maharjan, Himel Mallick, Eric A. Franzosa, Kelsey N. Thompson, Jacob T. Nearing, Curtis Huttenhower. 

MaAsLin 3: Refining and extending generalized multivariable linear models for meta-omic association discovery. bioRxiv 2024.12.13.628459; doi: https://doi.org/10.1101/2024.12.13.628459

    ]]></help>
</tool>
